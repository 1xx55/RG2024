# 单片机与树莓派通信协议
#### Author SleepNO1
在SleepNo1队伍的小车中，单片机与树莓派使用UART通信。此文档即为介绍单片机与树莓派通信数据的格式，由电控进行维护。相关通信代码见[com_to_raspi.c](SleepNo1/User/com_to_raspi.c)

**数据帧格式 : 帧头 + 消息类型标志位 + 附加数据(可选,紧跟着消息类型标志位后)**
#### 1.单片机接受树莓派数据
帧头：2字节，均为0x66

消息类型标志：1字节，表示传输的消息的类型。对于不同类型的消息，在消息类型标志后附带若干字节定长数据。以下是消息类型标志字节与其含义的对应关系(其宏定义位于[com_to_raspi.h](SleepNo1/User/com_to_raspi.h)
)，同时表格后附需要的附加数据格式：
|消息标志位的值|含义|附加数据|
|-|-|-|
|0x01| 向单片机传输机械臂4号舵机参数以在夹取时调整方块姿态|2字节，记为a、b; 舵机参数值应为a*256+b|
|0x02| 向单片机传输底盘向某方向移动某距离数据，底盘将平移到目的地| 3字节，记为a、b、c; a、b字节代表角度，以小车当前正前方方向为0度逆时针编码0-360度，角度值应为a*256+b。c字节代表距离，单位为cm。|
|0x03| 向单片机传输底盘原地旋转数据，底盘将原地旋转。|2字节，记为a、b;a、b字节代表角度，以小车当前正前方方向为0度逆时针编码-180~+180度，角度值应为a*256+b-180。(哎，角度范围是360度大于255没办法必须用2字节)|
|0x04| 向单片机传输顶部摄像头转动指令| 1字节，记为a。a=1代表顺时针旋转90度，a=2代表逆时针旋转90度，a=3代表旋转180度。a=4代表归零复位。
|0x05| 告诉单片机进行夹取动作 | 无|
|0x06| 告诉单片机进行发送动作 | 无|
#### 2.树莓派接受单片机数据
帧头：2字节，均为0x66

消息类型标志：1字节，表示传输的消息的类型。对应关系如下:
|消息标志位的值|含义|附加数据|
|-|-|-|
|0x81| 告诉树莓派此时机械臂上摄像头可开始拍照分析方块姿态，等待传回4号舵机参数|无|
|0x82| 告诉树莓派单片机此时已完成树莓派下达的底盘运动指令(0x02/0x03)|无|
|0x83| 告诉树莓派单片机此时已完成发射(发送该消息时机为摩擦轮刚停转时)|无|
|0x84| 告诉树莓派单片机此时已完成顶部摄像头旋转|无|
|0x85| 告诉树莓派单片机此时已完成夹取|无|



#### 3.注意事项
##### I.通信收发逻辑
(此部分已删除)
电控深知应该自行解算参数，而不是让树莓派去理解电控需要什么奇怪的参数，这样才能提高工作效率。
例如舵机需要旋转90度，单片机应该直接接收90度并自行解算成舵机参数，而不是让树莓派去算出舵机参数再发给单片机。(2024/09/04)
##### II.关于小车动作
如果受到一连串0x02/0x03运动指令，小车会按顺序执行他们。直到运动任务队列中所有任务全部执行结束才会返回0x82。

#### 4.后记
数据帧加帧头是为了防止读到错误数据或防止某数据解析不正确导致后续所有数据解析错误从而崩盘

此表格以及通信代码动态维护，如果有通信问题请及时联系电控。